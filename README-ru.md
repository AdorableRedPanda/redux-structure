# redux-structure-demo

## Редактирование графа с версионированием

В этом репозитории представлен пример структуры клиентской части приложения для совместного редактирования данных.
Основная задача - продемонстрировать подход к кодовой базе и использованию `Redux`.

[Демо](https://adorableredpanda.github.io/redux-structure-demo/)

## Основные требования к приложению

1. **Поддержка древовидной структуры данных**
   - Возможность добавлять и удалять вершины, редактировать их значения.
   - Возможность добавлять и удалять связи (рёбра) между вершинами.
   - При удалении вершины также удаляются её дочерние узлы и связанные рёбра.

2. **Совместное редактирование**
   - Поддержка одновременного редактирования проекта несколькими пользователями.
   - Синхронизация изменений между клиентами в реальном времени.

3. **Управление историей изменений и версионность**
   - Сохранение истории всех изменений с возможностью отката.
   - Возможность вернуться к любой из предыдущих версий проекта.

Для простоты примера, редактируемый проект представлен в виде объекта следующего типа:

```typescript
interface Project {
    nodes: Node[];
    edges: Edge[];
}

interface Position {
    x: number;
    y: number;
}

interface Node {
    id: ID;
    value: string;
    children: ID[];
    position: Position;
    parent: ID | null;
}

export interface Edge {
    id: ID;
    relation: [ID, ID];
}
```
## Redux как менеджер состояния проекта

Для работы с данными можно использовать любой state-менеджер, реализующий Flux-архитектуру, однако в данном примере используется **Redux**.

- **Совместное редактирование** упрощается за счёт сериализуемых экшенов, которые могут легко передаваться по сети.
- **Управление историей изменений** реализуется сохранением снапшотов состояния и экшенов, соответствующих действиям пользователей, в базе данных.

## Структура стора проекта

Логика работы с проектом реализована в папке `/src/store/core`. Ядро приложения экспортирует только:

- редьюсер проекта,
- сагу,
- селекторы.

Папка `/src/store/core` **не содержит никакой информации о клиенте или бэкенде**, что позволяет коду быть 
кроссплатформенным — его можно запускать как на фронтенде, так и на бэкенде.

Для примера, в папках `/src/store/client` и `/src/store/server` реализованы свои версии сторов, адаптированные для 
различных задач.

## Ограничения использования Redux

- **Независимые редьюсеры**: каждый редьюсер работает только с одним полем (`nodes` или `edges`). Shared редьюсеры отсутствуют.
- Для реализации связей между сторами используются **саги**.
- Каждый экшен обрабатывается единственным обработчиком — либо сагой, либо редьюсером.
- Для экшенов используется **минимальный payload** — только `id` сущности, без передачи целых объектов.
- Каждая сага решает конкретную задачу по реализации связи между сторами.

### Пример
Сложное действие, например, удаление ноды, требует:
- удаления самой ноды из стора,
- удаления связанных с ней рёбер,
- удаления дочерних нод.

Пример саги, реализующей это:

```typescript
function* deleteNode({ payload: { id  } }) {
   const nodes: Node[] = yield select(nodesSelector);
   const dependentNodes = getDependents(nodes, id);

   yield put(EdgeActions.deleteBy({ ids: dependentNodes }));
   yield put(NodesActions.delete({ ids: dependentNodes }));
}
```

## Структура фронтенд-приложения

Ранее я уже описывал в статье [DI in React](https://github.com/AdorableRedPanda/di-react-redux) некоторые сложности,
возникающие при использовании `Redux` в `React` компонентах. Это приложение можно рассматривать как пример изоляции 
использования стора от `React` компонентов.

Клиентская реализация стора описана в `/src/store/client`. Поскольку это демо-проект, для сохранения истории используется
тот же `Redux`, куда записываются действия пользователя. **Саги** применяются для обработки глобальных действий - 
фиксации изменений в истории (в реальном проекте это был бы запрос на бэкенд).

Папка `/src/store/client` содержит логику, связанную с `React`.
Экспортируются только провайдеры и хуки, оборачивающие использование селекторов и экшенов.
Задача этих хуков — изолировать компоненты от прямого взаимодействия со стором.

## Переиспользуемость и гибкость

В текущей реализации проекта можно **полностью заменить** реализацию стора:

- Перейти на другой state-менеджер.
- Перенести работу с тяжёлыми редьюсерами в **Service Worker**.
- Полностью перенести управление состоянием на **бэкенд**.

При этом код `React` компонентов останется **неизменным**, что делает архитектуру гибкой и легко адаптируемой под различные задачи.


## Режим разработки
Для запуска приложения:
- Скачайте [исходный код](https://github.com/AdorableRedPanda/redux-structure-demo)
- Установите зависимости `npm i`
- Запустите dev-сервер `npm run dev`

Приложение будет доступно по адресу `localhost:8080`
